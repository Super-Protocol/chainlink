#!/usr/bin/env bash
set -euo pipefail

GLOBAL_CONFIG_JSON_PATH="/sp/configurations/configuration.json"
mkdir -p /etc/price-aggregator

# Ensure config file exists; default to example if none provided
CONFIG_FILE_PATH=${CONFIG_FILE:-/etc/price-aggregator/config.yaml}
cat $GLOBAL_CONFIG_JSON_PATH | jq '.solution.priceAggregatorConfig' -r > $CONFIG_FILE_PATH

export CONFIG_FILE="$CONFIG_FILE_PATH"
export NODE_ENV=${NODE_ENV:-production}

cd /price-aggregator

# Build once if dist is missing
if [ ! -d "dist" ]; then
  echo "[price-aggregator] Building application..."
  npm run build
fi

echo "[price-aggregator] Starting..."
exec node dist/main
